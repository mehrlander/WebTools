<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Repository Viewer</title>
<script src="https://cdn.jsdelivr.net/combine/npm/@tailwindcss/browser@4,npm/jquery,npm/@phosphor-icons/web,npm/clipboard,npm/marked"></script>
<link href="https://cdn.jsdelivr.net/combine/npm/@tailwindcss/typography@0.5/dist/typography.min.css,npm/daisyui@5/themes.css,npm/daisyui@5" rel="stylesheet" />
</head>

<body class="min-h-screen bg-base-100">
<div class="max-w-7xl mx-auto px-2 py-3">
  <div class="mb-4 flex items-center justify-between">
    <div class="flex items-baseline gap-2 text-xl font-bold font-mono">
      <span id="ownerDisplay" class="text-base-content/70">...</span>
      <span class="text-base-content/30">/</span>
      <div class="dropdown dropdown-bottom">
        <div tabindex="0" role="button" class="hover:text-primary hover:underline decoration-2 underline-offset-4 transition-colors cursor-pointer flex items-center gap-1">
          <span id="repoNameDisplay">Loading...</span>
          <i class="ph ph-caret-down text-xs opacity-50"></i>
        </div>
        <ul id="repoDropdown" tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-200 rounded-box w-64 max-h-96 overflow-y-auto mt-1 text-sm"></ul>
      </div>
    </div>
    <div class="tooltip tooltip-left" id="authStatus">
      <i class="ph ph-circle-notch animate-spin text-lg"></i>
    </div>
  </div>
  
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-3">
    <div class="lg:col-span-1 flex flex-col gap-4">
      <div class="flex flex-col">
        <button class="flex items-center gap-1 font-semibold text-base py-0.5 hover:text-primary transition-colors toggle-btn mb-1" data-target="#fileTreeContainer" data-icon="#filesChevron">
          <i id="filesChevron" class="ph ph-caret-down transition-transform"></i>
          <span>Files</span>
        </button>
        <div id="fileTreeContainer">
          <div class="text-xs font-mono text-base-content/50 px-1 pb-1 truncate flex items-center gap-1">
            <i class="ph ph-folder-open"></i> <span id="currentFolderPath">/</span>
          </div>
          <div id="fileTree" class="overflow-y-auto text-sm bg-base-100 rounded-lg p-1 h-[33vh] border border-base-300">
            <div class="text-base-content/60 text-center py-3 text-sm">Loading...</div>
          </div>
        </div>
      </div>
      <div id="pulledSection"></div>
    </div>

    <div class="lg:col-span-3">
      <button class="flex items-center gap-1 font-semibold text-base py-0.5 hover:text-primary transition-colors mb-1 toggle-btn" data-target="#mainView" data-icon="#contentChevron">
        <i id="contentChevron" class="ph ph-caret-down transition-transform"></i>
        <span>Content</span>
      </button>
      <div id="mainView"></div>
    </div>
  </div>
</div>

<dialog id="urlsModal" class="modal">
  <div class="modal-box">
    <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button></form>
    <h3 class="font-bold text-lg mb-4">File URLs</h3>
    <div class="space-y-4" id="urlInputsContainer"></div>
    <div class="mt-6 pt-4 border-t border-base-300">
      <label class="label"><span class="label-text font-semibold text-success">Copied</span></label>
      <div class="bg-base-200 rounded p-3 min-h-[3rem] flex items-center">
        <div id="copiedUrlDisplay" class="text-xs font-mono break-all opacity-60">No URL copied yet</div>
      </div>
    </div>
  </div>
</dialog>

<script>
const GH_TOKEN = 'ðŸŽŸï¸GitHubToken'
const isAuth = !GH_TOKEN.includes('ðŸŽŸï¸')
const DEFAULT_USER = 'mehrlander'
const getHeaders = () => isAuth ? { 'Authorization': `Bearer ${GH_TOKEN.trim()}` } : {}

// Helpers for CodePen Prefill
const esc = s => new Option(String(s??"")).innerHTML
const pre = (l, s) => `<pre data-lang="${l}">${esc(s)}</pre>`

const itm = {
  treeItem: (f, curr) => `
    <div class="file-item group flex items-center justify-between p-1 hover:bg-base-200 rounded cursor-pointer transition-colors ${curr === f.path ? 'bg-primary/20' : ''}" data-path="${f.path}" data-type="${f.type}">
      <div class="flex items-center gap-1 min-w-0 overflow-hidden pointer-events-none">
        <i class="ph ${f.type === 'dir' ? 'ph-folder text-warning' : 'ph-file text-info'} flex-shrink-0"></i> 
        <span class="truncate">${f.name}</span>
      </div>
      ${f.type !== 'dir' ? `<button class="btn btn-ghost btn-xs w-6 h-6 min-h-0 p-0 hover:bg-base-300 text-base-content/40 hover:text-success pull-btn z-10" data-path="${f.path}" title="Add to Pull List"><i class="ph ph-plus-circle text-lg pointer-events-none"></i></button>` : ''}
    </div>`,

  pulls: (pillsHtml, combinedText, stats) => !pillsHtml ? '' : `
    <div class="flex flex-col gap-2">
      <div class="flex flex-wrap gap-1.5 content-start">${pillsHtml}</div>
      <div class="flex flex-col gap-1">
        <div class="flex items-center justify-between px-1">
          <span class="text-xs font-bold opacity-70 truncate">${stats}</span>
          <button type="button" class="btn btn-sm btn-square btn-ghost hover:text-primary copy-btn" title="Copy All" data-clipboard-text="${combinedText.replace(/"/g, '&quot;')}"><i class="ph ph-copy text-lg"></i></button>
        </div>
        <div class="tab-[2] overflow-auto whitespace-pre font-mono text-xs border border-base-300 rounded-lg p-2 bg-base-100 h-[25vh] w-full text-base-content/80">${combinedText}</div>
      </div>
    </div>`,

  viewer: (path, stats, canPreview, isPreview, isCp) => {
    const isHtmlPreview = canPreview && isPreview && path.endsWith('.html')
    // FIX: Added 'w-full' to the second branch of the conditional
    const boxClass = isHtmlPreview || isCp
      ? 'h-[calc(100vh-190px)] w-full border border-base-300 rounded-lg overflow-hidden bg-base-100' 
      : `tab-[2] overflow-auto ${isPreview ? '' : 'whitespace-pre font-mono'} text-xs border border-base-300 rounded-lg p-3 bg-base-100 flex-grow w-full h-[calc(100vh-190px)] text-base-content/90`
    
    const ext = path ? path.split('.').pop().toLowerCase() : ''
    const canCp = ['html','js','css'].includes(ext)
    const btnBase = "btn btn-sm btn-square btn-ghost hover:bg-base-200 text-base-content/70 hover:text-primary transition-colors"

    return `
    <div class="space-y-2">
      <div class="flex items-center justify-between">
        <div class="flex-1 min-w-0 pr-2">
          <div class="text-sm font-medium font-mono truncate">${path || 'No file selected'}</div>
          <div class="text-xs text-base-content/60">${stats || ''}</div>
        </div>
        <div class="flex items-center gap-1">
          ${canPreview ? `
            <button id="previewToggle" class="${btnBase} ${isPreview ? 'text-primary bg-primary/10' : ''}">
              <i class="ph ${isPreview ? 'ph-code' : 'ph-eye'} text-lg"></i>
            </button>` : ''}
          
          ${canCp ? `
            <button id="cpToggle" class="${btnBase} ${isCp ? 'text-primary bg-primary/10' : ''}">
              <i class="ph ph-codepen-logo text-lg"></i>
            </button>` : ''}
          
          <button class="${btnBase} file-copy-btn" ${!path ? 'disabled' : ''}>
            <i class="ph ph-copy text-lg"></i>
          </button>
          
          <button id="urlsButton" class="${btnBase}" ${!path ? 'disabled' : ''}>
            <i class="ph ph-link text-lg"></i>
          </button>
        </div>
      </div>
      <div class="flex w-full">
        <div id="fileContentBox" class="${boxClass} ${isPreview && !isHtmlPreview ? 'prose prose-sm max-w-none px-4 py-2' : ''}"></div>
      </div>
    </div>`
  },

  pill: (path) => `
    <div class="inline-flex items-center gap-1 pl-2 pr-1 py-0.5 bg-base-200 hover:bg-base-300 border border-base-300 rounded-full text-[10px] transition-colors group cursor-default shadow-sm">
      <span class="truncate max-w-[140px] font-mono" title="${path}">${path}</span>
      <button class="btn btn-ghost btn-xs w-4 h-4 min-h-0 p-0 rounded-full text-base-content/40 hover:text-error hover:bg-base-100 remove-pull-btn" data-path="${path}"><i class="ph ph-x"></i></button>
    </div>`,
    
  urlInput: (label, id, val) => `
    <div>
      <label class="label"><span class="label-text font-semibold">${label}</span></label>
      <div class="join w-full">
        <input id="${id}" type="text" value="${val}" class="input input-bordered input-sm join-item flex-1 font-mono text-xs" readonly />
        <button class="btn btn-sm join-item copy-btn" data-clipboard-target="#${id}"><i class="ph ph-copy"></i></button>
      </div>
    </div>`
}

let currentRepo = null, currentFile = null, currentRawContent = '', pulledFiles = new Set(), isPreview = false, isCpMode = false
const formatCode = (txt) => txt.replace(/ {4}/g, '  ')
const getStats = (txt) => { const b = new Blob([txt]).size; return `${txt.split('\n').length} lines â€¢ ${(b/1024).toFixed(1)} KB`; }

const showError = (err) => {
  const msg = err.status === 401 ? 'Token Invalid' : (err.msg || 'Unknown Error')
  $('#fileTree').html(`<div class="p-4 text-error text-center text-xs space-y-2"><div class="font-bold"><i class="ph ph-warning"></i> ${msg}</div><div class="font-mono opacity-70">HTTP ${err.status || 'N/A'}</div></div>`)
}

async function fetchFile(path) {
  const res = await fetch(`https://api.github.com/repos/${currentRepo}/contents/${path}`, { headers: getHeaders() })
  if (!res.ok) throw { status: res.status }
  const binaryString = atob((await res.json()).content.replace(/\s/g, ''))
  const bytes = new Uint8Array(binaryString.length)
  for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i)
  return new TextDecoder('utf-8').decode(bytes)
}

async function renderAsync(containerId, dataFetcher, renderer) {
  const $el = $(containerId)
  $el.html(renderer('// Loading...', 'Processing...'))
  try {
    const { c, s } = await dataFetcher()
    $el.html(renderer(c, s))
  } catch (e) { $el.html(renderer('// Error loading content', 'Error')) }
}

function renderViewUpdate() {
  if (!currentFile) return
  const isMd = currentFile.endsWith('.md')
  const isHtml = currentFile.endsWith('.html')
  
  $('#mainView').html(itm.viewer(currentFile, getStats(currentRawContent), isMd || isHtml, isPreview, isCpMode))
  
  // 1. CodePen Mode (New API Approach)
  if (isCpMode) {
    const ext = currentFile.split('.').pop().toLowerCase()
    const validLangs = ['html', 'css', 'js']
    const lang = validLangs.includes(ext) ? ext : 'html'
    const h = $('#fileContentBox').height() || 600
    const embedHtml = `
      <div class="codepen" 
           data-version="2"
           data-prefill 
           data-height="${h}" 
           data-theme-id="light" 
           data-default-tab="${lang},result"
           style="height:100%;display:flex;align-items:center;justify-content:center;">
        ${pre(lang, currentRawContent)}
      </div>`
    
    $('#fileContentBox').html(embedHtml)
    
    if (window.__CPEmbed) {
      window.__CPEmbed("#fileContentBox .codepen")
    } else {
      const s = document.createElement('script')
      s.src = 'https://public.codepenassets.com/embed/index.js'
      s.onload = () => window.__CPEmbed("#fileContentBox .codepen")
      document.body.appendChild(s)
    }
    return
  }

  // 2. Preview Mode
  if (isPreview) {
    if (isMd) $('#fileContentBox').html(marked.parse(currentRawContent))
    if (isHtml) {
      const blob = new Blob([currentRawContent], {type: 'text/html'})
      const url = URL.createObjectURL(blob)
      $('#fileContentBox').html(`<iframe src="${url}" class="w-full h-full border-none bg-white" sandbox="allow-scripts allow-modals"></iframe>`)
    }
  } 
  // 3. Code Mode
  else {
    $('#fileContentBox').text(formatCode(currentRawContent))
  }
}

function renderMain(path) {
  currentFile = path; isPreview = false; isCpMode = false; currentRawContent = ''
  
  // Update Selection
  $('.file-item').removeClass('bg-primary/20')
  if (path) $(`.file-item[data-path="${path}"]`).addClass('bg-primary/20')

  if (!path) return $('#mainView').html(itm.viewer(null, '', false, false, false))

  renderAsync('#mainView',
    async () => {
      currentRawContent = await fetchFile(path)
      return { c: null, s: null }
    },
    (c, s) => {
       if (s === 'Error') return itm.viewer(path, '// Error loading file', 'Error', false, false, false)
       if (c === '// Loading...') return itm.viewer(path, '// Loading...', '', false, false, false)
       setTimeout(renderViewUpdate, 0) 
       return itm.viewer(path, 'Loading...', '', false, false, false) 
    }
  )
}

function renderPulled() {
  const files = Array.from(pulledFiles)
  if (!files.length) return $('#pulledSection').html(itm.pulls(null))
  
  renderAsync('#pulledSection',
    async () => {
      const contents = await Promise.all(files.map(async p => {
        try { return `// === ${p} ===\n${formatCode(await fetchFile(p))}` } 
        catch { return `// === ERROR: ${p} ===` }
      }))
      const c = contents.join('\n\n')
      return { c, s: `Combined (${files.length} files â€¢ ${getStats(c).split('â€¢')[1]})` }
    },
    (c, s) => itm.pulls(files.map(itm.pill).join(''), c, s)
  )
}

async function loadRepoList() {
  try {
    const url = isAuth ? 'https://api.github.com/user/repos' : `https://api.github.com/users/${DEFAULT_USER}/repos`
    const res = await fetch(`${url}?sort=updated&per_page=100`, { headers: getHeaders() })
    if (!res.ok) throw { status: res.status, msg: 'Fetch failed' }
    
    const repos = await res.json()
    if (!repos.length) return
    
    $('#repoDropdown').html(repos.map(r => `<li><a onclick="selectRepo('${r.full_name}','${r.owner.login}','${r.name}')" class="font-mono text-xs">${r.private?'ðŸ”’':''} ${r.name}</a></li>`).join(''))
    const user = isAuth ? (await (await fetch('https://api.github.com/user', {headers:getHeaders()})).json()).login : DEFAULT_USER
    $('#authStatus').attr('data-tip', isAuth ? `Authenticated: ${user}` : 'Public Only').html(`<i class="ph ${isAuth?'ph-shield-check text-success':'ph-globe text-base-content/50'} text-xl"></i>`)
    
    const init = repos.find(r => r.name === 'WebTools') || repos[0]
    selectRepo(init.full_name, init.owner.login, init.name)
  } catch(e) { showError(e) }
}

async function loadTree(path = '') {
  try {
    const res = await fetch(`https://api.github.com/repos/${currentRepo}/contents/${path}`, { headers: getHeaders() })
    if (!res.ok) throw { status: res.status }
    const items = (await res.json()).sort((a,b) => a.type===b.type ? a.name.localeCompare(b.name) : a.type==='dir'?-1:1)
    $('#fileTree').html((path ? `<div class="file-item px-1 py-0.5 hover:bg-base-200 rounded cursor-pointer font-mono" data-path="${path.split('/').slice(0, -1).join('/')}" data-type="back"><i class="ph ph-folder text-warning"></i> ..</div>` : '') + items.map(f => itm.treeItem(f, currentFile)).join(''))
    $('#currentFolderPath').text(path ? `/${path}` : '/')
  } catch(e) { showError(e) }
}

window.selectRepo = (full, owner, name) => {
  currentRepo = full; pulledFiles.clear(); renderPulled(); renderMain(null)
  $('#ownerDisplay').text(owner); $('#repoNameDisplay').text(name)
  document.activeElement.blur(); loadTree()
}

$('.toggle-btn').on('click', function() { $($(this).data('target')).toggle(); $($(this).data('icon')).toggleClass('ph-caret-down ph-caret-right') })
$('#fileTree').on('click', '.pull-btn', function(e) { e.stopPropagation(); pulledFiles.add($(this).data('path')); renderPulled() })
$('#fileTree').on('click', '.file-item', function(e) { if ($(e.target).closest('.pull-btn').length) return; const { path, type } = $(this).data(); type === 'dir' || type === 'back' ? loadTree(path) : renderMain(path) })
$('#mainView').on('click', '#previewToggle', function() { isPreview = !isPreview; isCpMode = false; renderViewUpdate() })
$('#mainView').on('click', '#cpToggle', function() { isCpMode = !isCpMode; isPreview = false; renderViewUpdate() })
$('body').on('click', '.remove-pull-btn', (e) => { pulledFiles.delete($(e.currentTarget).data('path')); renderPulled() })
$('#mainView').on('click', '#urlsButton', () => { 
  if (!currentFile) return
  $('#urlInputsContainer').html([{ l: 'GitHub', v: `https://github.com/${currentRepo}/blob/main/${currentFile}` }, { l: 'JSDelivr', v: `https://cdn.jsdelivr.net/gh/${currentRepo}/${currentFile}` }].map((d,i) => itm.urlInput(d.l, `url_${i}`, d.v)).join(''))
  urlsModal.showModal()
})

$(() => {
  const initCopy = (sel, txtFn) => new ClipboardJS(sel, txtFn ? { text: txtFn } : {}).on('success', e => {
    const btn = e.trigger, orig = btn.innerHTML
    btn.innerHTML = `<i class="ph ph-check text-success"></i>${$(btn).closest('#urlsModal').length ? '' : ''}`
    if($(btn).closest('#urlsModal').length) $('#copiedUrlDisplay').text(e.text).removeClass('opacity-60')
    setTimeout(() => btn.innerHTML = orig, 1500); e.clearSelection()
  })
  initCopy('.file-copy-btn', () => currentRawContent)
  initCopy('.copy-btn')
  loadRepoList()
})
</script>
</body>
</html>
