<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://cdn.jsdelivr.net/combine/npm/daisyui@5/themes.css,npm/daisyui@5" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/combine/npm/@tailwindcss/browser@4,npm/@phosphor-icons/web"></script>
  <script defer src="https://cdn.jsdelivr.net/combine/npm/alpinejs@3/dist/cdn.min.js,npm/@alpinejs/sort@3/dist/cdn.min.js"></script>
</head>

<body class="bg-base-200 antialiased select-none overflow-hidden h-screen flex flex-col" data-theme="emerald" x-data="explorer()">

  <header class="bg-base-100 border-b border-base-300 flex items-center z-30 shrink-0 h-12">
    <nav class="flex-1 flex items-center text-[13px] font-mono overflow-x-auto px-3 h-full [&::-webkit-scrollbar]:hidden [scrollbar-width:none]">
      <template x-for="(bc, i) in crumbs" :key="bc.id">
        <div class="flex items-center shrink-0">
          <span x-show="i > 0" class="opacity-20 px-0.5">/</span>
          <ul 
            :id="bc.id" :data-target="bc.id" data-type="breadcrumb" :data-path="bc.path"
            x-sort="[]" x-sort:group="files"
            x-sort:config="{ ghostClass: 'w-0', dragClass: 'opacity-0', onStart: e => handleStart(e), onMove: e => handleMove(e), onEnd: e => handleEnd(e) }"
            @click="cd(bc.path)"
            class="group inline-flex items-center rounded px-2 py-1 mr-1 cursor-pointer hover:bg-base-200 transition-all duration-200"
            :class="hot === bc.id ? 'bg-primary/10 scale-105' : ''"
          >
            <span class="relative">
              <span class="font-bold truncate max-w-[110px]" :class="i === 0 ? 'text-base-content' : 'text-primary'" x-text="bc.label"></span>
              <template x-if="counts[bc.id]">
                <button @click.stop="clearSegment(bc.id)" class="absolute -top-2 -right-3 flex h-3.5 w-3.5 items-center justify-center rounded-full bg-base-100 text-base-content/50 hover:bg-error hover:text-error-content transition-colors border border-base-300 shadow-sm z-10">
                  <i class="ph ph-x text-[8px] font-bold"></i>
                </button>
              </template>
              <template x-if="counts[bc.id]">
                <span class="absolute -bottom-2 -right-2 flex h-3.5 min-w-[14px] items-center justify-center rounded-full px-1 text-[8px] font-bold text-primary-content shadow-sm ring-1 ring-base-100 transition-all duration-300" :class="hot === bc.id ? 'bg-error scale-125' : 'bg-primary'" x-text="counts[bc.id]"></span>
              </template>
            </span>
          </ul>
        </div>
      </template>
      <div class="w-6 shrink-0"></div>
    </nav>
  </header>

  <main class="flex-1 overflow-y-auto bg-base-100 border-b border-base-300">
    <div class="bg-base-200/50 border-b border-base-200 divide-y divide-base-200">
      <template x-for="dir in directories" :key="dir.id">
        <ul :id="dir.id" :data-target="dir.id" data-type="folder" :data-path="dir.path"
            x-sort="[]" x-sort:group="files"
            x-sort:config="{ onStart: e => handleStart(e), onMove: e => handleMove(e), onEnd: e => handleEnd(e), emptyInsertThreshold: 20 }"
            class="flex items-center gap-2 px-4 h-12 transition-colors" :class="hot === dir.id ? 'bg-warning/20' : 'hover:bg-base-100'">
          <div @click.stop="cd(dir.path)" class="flex items-center gap-2 shrink-0 cursor-pointer group relative mr-2">
            <i class="ph-fill ph-folder text-warning text-lg"></i>
            <span class="font-mono text-[12px] font-bold text-base-content/70 group-hover:text-warning transition-colors" x-text="dir.name"></span>
            <template x-if="counts[dir.id]">
              <button @click.stop="clearSegment(dir.id)" class="absolute -top-1 -right-5 flex h-3.5 w-3.5 items-center justify-center rounded-full bg-base-100 text-base-content/50 hover:bg-error hover:text-error-content transition-colors border border-base-300 shadow-sm z-10">
                <i class="ph ph-x text-[8px] font-bold"></i>
              </button>
            </template>
            <template x-if="counts[dir.id]">
              <span class="absolute -bottom-1 -right-4 flex h-3.5 min-w-[14px] items-center justify-center rounded-full px-1 text-[8px] font-bold text-warning-content shadow-sm ring-1 ring-base-100 transition-all duration-300" :class="hot === dir.id ? 'bg-error scale-125' : 'bg-warning'" x-text="counts[dir.id]"></span>
            </template>
          </div>
        </ul>
      </template>
    </div>

    <ul id="file-list" data-target="file-list" data-type="root"
        x-sort="items" x-sort:group="files"
        x-sort:config="{ onStart: e => handleStart(e), onMove: e => handleMove(e), onEnd: e => handleEnd(e) }"
        class="divide-y divide-base-200 min-h-[100px] bg-base-100">
      <template x-for="id in items" :key="id">
        <li x-sort:item="id" :data-id="id" :data-name="byId[id]?.name" :data-path="byId[id]?.path" :class="css.ROOT">
          <i class="ph ph-file-text text-base-content/30 text-lg"></i>
          <span class="flex-1 font-mono text-[13px] text-base-content/60 truncate" x-text="byId[id]?.name"></span>
        </li>
      </template>
    </ul>
  </main>

  <section class="h-48 flex flex-col bg-neutral text-success font-mono text-[10px] z-40 shrink-0">
    <div class="flex items-center justify-between px-3 py-2 border-b border-neutral-content/10 shrink-0">
      <span class="opacity-50 uppercase tracking-widest">Staged Moves</span>
      <span class="text-[9px] text-neutral-content/50" x-show="Object.keys(staged).length" x-text="Object.keys(staged).length + ' pending'"></span>
    </div>
    <div class="flex-1 overflow-y-auto p-3">
      <pre class="whitespace-pre-wrap" x-text="JSON.stringify(staged, null, 2)"></pre>
    </div>
  </section>

  <script>
    const GH_TOKEN = 'ğŸŸï¸GitHubToken', REPO = 'mehrlander/wa-bills';

    function explorer() {
      const css = {
        ROOT: 'flex items-center gap-3 px-5 py-3 hover:bg-base-200 cursor-grab active:cursor-grabbing bg-base-100',
        PILL: 'px-1.5 py-px rounded-full text-[9px] font-semibold cursor-grab active:cursor-grabbing leading-tight flex items-center bg-warning/20 text-warning-content',
        HIDDEN: 'hidden',
        GHOST: 'w-0 h-0 overflow-hidden opacity-0 pointer-events-none'
      };

      return {
        css,
        byId: {}, items: [], directories: [], currentPath: '', hot: null, counts: {}, staged: {},

        get isAuth() { return !GH_TOKEN.includes('ğŸŸï¸'); },
        get pathParts() { return this.currentPath ? this.currentPath.split('/') : []; },
        get crumbs() {
          return [{ id: 'bc-root', label: 'wa-bills', path: '' },
            ...this.pathParts.map((p, i) => ({ id: 'bc-' + i, label: p, path: this.pathParts.slice(0, i + 1).join('/') }))];
        },

        getHeaders() { return this.isAuth ? { Authorization: `Bearer ${GH_TOKEN.trim()}`, Accept: 'application/vnd.github.v3+json' } : {}; },

        async init() { await this.cd(''); },

        async cd(path) {
          this.staged = {}; this.counts = {};
          document.querySelectorAll('[data-type="breadcrumb"] li, [data-type="folder"] li').forEach(el => el.remove());
          this.currentPath = path; this.items = []; this.directories = []; this.byId = {};
          try {
            const data = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, { headers: this.getHeaders() }).then(r => r.json());
            if (!Array.isArray(data)) return;
            data.forEach(item => {
              const id = `${item.type}:${item.path}`;
              this.byId[id] = { id, name: item.name, type: item.type, path: item.path };
              item.type === 'dir' ? this.directories.push(this.byId[id]) : this.items.push(id);
            });
          } catch (e) { console.error(e); }
        },

        clearSegment(id) {
          const seg = document.getElementById(id), root = document.getElementById('file-list');
          if (!seg || !root) return;
          seg.querySelectorAll('li').forEach(li => { li.className = css.ROOT; root.appendChild(li); });
          this.updateStaged();
        },

        handleStart(e) { e.item.className = css.ROOT; },
        handleMove(e) {
          this.hot = e.to.dataset.target;
          e.dragged.className = { breadcrumb: css.GHOST, folder: css.PILL, root: css.ROOT }[e.to.dataset.type];
        },
        handleEnd(e) {
          this.hot = null;
          if (e?.to.dataset.type === 'breadcrumb') e.item.className = css.HIDDEN;
          this.updateStaged();
        },

        updateStaged() {
          this.staged = {}; this.counts = {};
          document.querySelectorAll('[data-type="breadcrumb"], [data-type="folder"]').forEach(el => {
            const items = el.querySelectorAll('li');
            if (items.length) {
              this.staged[el.dataset.path] = Array.from(items).map(li => li.dataset.path);
              this.counts[el.dataset.target] = items.length;
            }
          });
        }
      };
    }
  </script>
</body>
</html>
