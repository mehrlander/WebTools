<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HTML Previewer</title>
<script src="https://cdn.jsdelivr.net/combine/npm/@tailwindcss/browser@4,npm/@phosphor-icons/web"></script>
<link href="https://cdn.jsdelivr.net/combine/npm/daisyui@5/themes.css,npm/daisyui@5" rel="stylesheet" />
<script src="https://unpkg.com/alpinejs" defer></script>
</head>
<body class="min-h-screen bg-base-200" x-data="previewer()">

<div class="drawer lg:drawer-open">
  <input id="drawer" type="checkbox" class="drawer-toggle" x-model="drawerOpen" />
  
  <div class="drawer-content flex flex-col h-screen">
    <div class="p-2 bg-base-100 border-b border-base-300 flex items-center gap-2">
      <label for="drawer" class="btn btn-square btn-ghost btn-sm lg:hidden">
        <i class="ph ph-list text-xl"></i>
      </label>
      <i class="ph ph-file-html text-lg text-info"></i>
      
      <span class="font-mono text-sm truncate flex-1" x-text="currentPath || 'Select a file'"></span>
      
      <template x-if="currentPath">
        <div class="flex gap-1">
          <button @click="isRawView = !isRawView" class="btn btn-ghost btn-xs" :title="isRawView ? 'Show Preview' : 'Show Code'">
            <i class="ph text-lg" :class="isRawView ? 'ph-eye' : 'ph-code'"></i>
          </button>
          <a :href="rawUrl" target="_blank" class="btn btn-ghost btn-xs" title="Open in New Tab">
            <i class="ph ph-arrow-square-out text-lg"></i>
          </a>
        </div>
      </template>
    </div>

    <iframe x-ref="iframe" class="flex-1 bg-white" :class="{ 'hidden': isRawView }" sandbox="allow-scripts allow-modals"></iframe>
    
    <pre class="flex-1 bg-base-100 p-4 overflow-auto text-xs font-mono" 
         x-show="isRawView" 
         x-text="currentContent" 
         style="display: none;"></pre>
  </div>

  <div class="drawer-side">
    <label for="drawer" class="drawer-overlay"></label>
    <aside class="w-72 min-h-full bg-base-100 flex flex-col">
      <div class="p-3 border-b border-base-300">
        <div class="flex items-center justify-between">
          <div class="font-mono text-sm font-bold" x-text="repo"></div>
          <div class="flex items-center gap-1">
            <button @click="loadFiles" class="hover:text-primary transition-colors" title="Refresh">
              <i class="ph ph-arrow-clockwise text-lg text-base-content/50 hover:text-primary"></i>
            </button>
            
            <div class="tooltip tooltip-left" :data-tip="token ? 'Authenticated' : 'Public Only'">
              <i class="ph text-lg" 
                 :class="token ? 'ph-shield-check text-success' : 'ph-globe text-base-content/50'"></i>
            </div>
          </div>
        </div>
        <div class="text-xs text-base-content/60 mt-1">HTML Files</div>
      </div>

      <ul class="menu menu-sm flex-1 overflow-y-auto p-2">
        <li x-show="loading"><span class="loading loading-spinner loading-sm"></span></li>
        
        <template x-for="file in files" :key="file.path">
          <li>
            <a class="font-mono text-xs" 
               :class="{ 'active': currentPath === file.path }"
               @click="selectFile(file.path)">
              <i class="ph ph-file-html text-info"></i>
              <span x-text="file.path.split('/').pop()"></span>
            </a>
          </li>
        </template>
      </ul>
    </aside>
  </div>
</div>

<script>
function previewer() {
  return {
    repo: 'mehrlander/WebTools',
    storedToken: 'üéüÔ∏èGitHubToken',
    get token() { return this.storedToken.includes('üéüÔ∏è') ? '' : this.storedToken.trim() },
    
    files: [],
    currentPath: null,
    currentContent: '',
    isRawView: false,
    loading: false,
    drawerOpen: false,

    get rawUrl() {
      return `https://cdn.jsdelivr.net/gh/${this.repo}@main/${this.currentPath}`
    },

    init() {
      this.loadFiles()
      window.auth = (t) => { this.storedToken = t; this.loadFiles() }
    },

    async loadFiles() {
      this.loading = true
      const headers = this.token ? { 'Authorization': `Bearer ${this.token}` } : {}
      try {
        const res = await fetch(`https://api.github.com/repos/${this.repo}/git/trees/main?recursive=1`, { headers })
        const data = await res.json()
        this.files = data.tree.filter(f => f.type === 'blob' && f.path.endsWith('.html'))
      } catch (e) { console.error(e) }
      this.loading = false
    },

    async selectFile(path) {
      this.currentPath = path
      this.isRawView = false
      this.drawerOpen = false
      
      this.currentContent = await (await fetch(this.rawUrl)).text()
      
      const sentinel = 'üéüÔ∏è' + 'GitHubToken'
      const injected = this.token ? this.currentContent.replace(new RegExp(sentinel, 'g'), this.token) : this.currentContent
      
      const blob = new Blob([injected], { type: 'text/html' })
      this.$refs.iframe.src = URL.createObjectURL(blob)
    }
  }
}
</script>
</body>
</html>
